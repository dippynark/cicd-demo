apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: istio-install
spec:
  serviceAccountName: istio-install
  params:
  - name: ISTIO_TARGET_VERSION
    value: "1.9.0"
  - name: NAMESPACES
    value: "bookinfo,cert-manager"
  pipelineSpec:
    params:
    - description: Istio version to install or upgrade to
      name: ISTIO_TARGET_VERSION
      type: string
    - description: Namespaces to inject sidecars into
      name: NAMESPACES
      type: string
    tasks:
    - name: istio-install
      params:
      - name: ISTIO_TARGET_VERSION
        value: $(params.ISTIO_TARGET_VERSION)
      - name: NAMESPACES
        value: $(params.NAMESPACES)
      taskSpec:
        params:
        - description: Istio version to install or upgrade to
          name: ISTIO_TARGET_VERSION
          type: string
        - description: Namespaces to inject sidecars into
          name: NAMESPACES
          type: string
        stepTemplate:
          name: ""
        steps:
        - name: istio-install
          image: istio/istioctl:$(inputs.params.ISTIO_TARGET_VERSION)
          securityContext:
            runAsUser: 0
          command:
          - /bin/bash
          args:
          - -uxec
          - |
            set -o pipefail

            apt-get update && apt-get install -y curl jq

            # Install kubectl
            # https://kubernetes.io/docs/tasks/tools/install-kubectl/
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

            ISTIO_TARGET_VERSION="$(inputs.params.ISTIO_TARGET_VERSION)"
            SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

            # Change to script directory
            cd "$(dirname "${BASH_SOURCE[0]}")"

            ISTIO_TARGET_REVISION=$(echo "$ISTIO_TARGET_VERSION" | tr '.' '-')
            ISTIO_EXISTING_VERSIONS=$(istioctl version -o json | grep -v "no running Istio pods" | jq -r '.meshVersion[]? | .Info.tag')

            # Install target version
            istioctl install -y \
              --set tag="$ISTIO_TARGET_VERSION" \
              --set revision="$ISTIO_TARGET_REVISION"

            # Remove Namespaces
            NAMESPACES=$(echo "$(inputs.params.NAMESPACES)" | tr ',' '\n')
            ALL_NAMESPACES=$(kubectl get ns -l istio.io/rev --no-headers --ignore-not-found -o jsonpath='{.items[*].metadata.name}')
            for NAMESPACE in $ALL_NAMESPACES; do
              if echo "$NAMESPACES" | grep "^$NAMESPACE$"; then
                continue
              fi
              kubectl label namespace "$NAMESPACE" istio.io/rev-
              # Roll Deployments
              DEPLOYMENTS=$(kubectl get deployments -n "$NAMESPACE" --no-headers --ignore-not-found -o jsonpath='{.items[*].metadata.name}')
              for DEPLOYMENT in $DEPLOYMENTS; do
                kubectl rollout restart deployment -n "$NAMESPACE" "$DEPLOYMENT"
                kubectl rollout status deployment -n "$NAMESPACE" "$DEPLOYMENT"
              done
            done

            # Add Namespaces
            for NAMESPACE in $NAMESPACES; do
              kubectl label namespace "$NAMESPACE" istio.io/rev="$ISTIO_TARGET_REVISION" --overwrite
              # Roll Deployments
              DEPLOYMENTS=$(kubectl get deployments -n "$NAMESPACE" --no-headers --ignore-not-found -o jsonpath='{.items[*].metadata.name}')
              for DEPLOYMENT in $DEPLOYMENTS; do
                kubectl rollout restart deployment -n "$NAMESPACE" "$DEPLOYMENT"
                kubectl rollout status deployment -n "$NAMESPACE" "$DEPLOYMENT"
              done
            done

            # Uninstall previous version(s)
            for ISTIO_VERSION in $ISTIO_EXISTING_VERSIONS; do
              if [ "$ISTIO_VERSION" = "$ISTIO_TARGET_VERSION" ]; then
                continue
              fi
              istioctl x uninstall -y --revision="$(echo "$ISTIO_VERSION" | tr '.' '-')"
            done
